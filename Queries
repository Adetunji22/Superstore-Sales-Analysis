 -- create a table that will contain the csv file to work on
 create table US_superstore (Row_ID    int,
			  Order_ID   text,
			  Order_Date   date,
			  Ship_Date	    date,
			  Ship_Mode	   varchar,
			  Customer_ID    text,
			  Customer_Name   varchar,
			  Segment         varchar,
			  Country        varchar,
			  City	          varchar,
			  State	         varchar,
			  Postal_Code     int,
			  Region	      varchar,
			  Product_ID	text,
			  Category	     varchar,
			  Sub_Category	    varchar,
			  Product_Name	     varchar,
			  Sales	            numeric,
			  Quantity	        int,
			  Discount	     numeric,
			  Profit          numeric
);

----importing the data ino the table
copy US_superstore from 
'C:\Program Files\PostgreSQL\9.6\data\US_Superstore_data.csv' csv header

--taking a look at the table
select * from US_superstore;

-----------------------------------------------exploring the data-----------------------------------------------

1.    --------  finding the revenues generated by category

  select Category, cast(sum(sales) as money)as revenue
  from US_superstore group by Category order by revenue desc;
  
2.   ----------most profitable/least profitable category
  (select Category, cast(sum(Profit)as money)as profits
  from US_superstore group by Category order by profits desc limit 1)
  UNION
    (select Category, cast(sum(Profit)as money)as profits
  from US_superstore group by Category order by profits asc limit 1);
  
3.     -----------the top 5 subcategories with the highest revenue
 select Category, Sub_Category, cast(sum(sales) as money)as revenues
  from US_superstore group by Category,Sub_Category order by revenues desc limit 5;
  
4.        ------most profitable/least profitable subcategory
  (select Sub_Category, cast(sum(Profit)as money)as profits
  from US_superstore group by Sub_Category order by profits desc limit 1)
  UNION
    (select Sub_Category, cast(sum(Profit)as money)as profits
  from US_superstore group by Sub_Category order by profits asc limit 1);
  
  
5.   --most profitable customer segment
   select Segment, cast(sum(Profit) as money)as profits
  from US_superstore group by Segment order by profits desc limit 1;
  
  
6. -- cities and their sum of sales
  select City, cast(sum(sales)as money) as revenues 
  from US_superstore group by City order by revenues desc;
  
  
7.  ------most profitable year
  select extract(year from order_date)as years, cast(sum(Profit)as money) as profit
  from US_superstore group by extract(year from order_date) order by profit desc
  
  
8.  ----total revenue generated per year for each subcategory
  
 with S_14 AS (
 select extract(year from order_date)as years,Sub_Category, cast(sum(sales)as money)as rev_2014
	 from US_superstore where extract(year from order_date)=2014
	 group by Sub_Category,extract(year from order_date)),
	 S_15 AS (
 select extract(year from order_date)as years,Sub_Category, cast(sum(sales)as money)as rev_2015
	 from US_superstore where extract(year from order_date)=2015
	 group by Sub_Category,extract(year from order_date)),
	 S_16 AS (
 select extract(year from order_date)as years,Sub_Category, cast(sum(sales)as money)as rev_2016
	 from US_superstore where extract(year from order_date)=2016
	 group by Sub_Category,extract(year from order_date)),
	 S_17 AS (
 select extract(year from order_date)as years,Sub_Category, cast(sum(sales)as money)as rev_2017
	 from US_superstore where extract(year from order_date)=2017
	 group by Sub_Category,extract(year from order_date))
	 
	 select S_14.Sub_Category,rev_2014, rev_2015,rev_2016, rev_2017,
	 (rev_2014+rev_2015+rev_2016+rev_2017)as total_revenue
	 from S_14 JOIN S_15 ON
	 S_14.Sub_Category=S_15.Sub_Category
	 JOIN S_16 ON S_15.Sub_Category=S_16.Sub_Category
	 JOIN S_17 ON S_16.Sub_Category=S_17.Sub_Category
  
  9. ------TOP 2 SUBCATEGORIES IN EVERY REGION BY REVENUE
	 with T2 as (
	 select region, Sub_Category, cast(sum(sales)as money)as revenue,
	 rank()over(partition by region order by cast(sum(sales)as money)desc)as revenue_rank from US_superstore 
	 group by region, Sub_Category )
	    select * from T2 where revenue_rank<3
	 
